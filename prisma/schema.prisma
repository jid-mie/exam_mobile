generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Gender {
  male
  female
  other
}

enum Specialization {
  Cardiology
  Dermatology
  Pediatrics
  Orthopedics
  General
}

enum AppointmentStatus {
  scheduled
  confirmed
  completed
  cancelled
  no_show
}

model Patient {
  id               Int       @id @default(autoincrement())
  email            String    @unique
  password         String
  fullName         String    @map("full_name")
  phoneNumber      String?   @map("phone_number")
  dateOfBirth      DateTime? @map("date_of_birth")
  gender           Gender?
  address          String?
  bloodType        String?   @map("blood_type")
  emergencyContact String?   @map("emergency_contact")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  appointments Appointment[]

  @@map("patients")
}

model Doctor {
  id              Int            @id @default(autoincrement())
  email           String         @unique
  password        String
  fullName        String         @map("full_name")
  phoneNumber     String?        @map("phone_number")
  specialization  Specialization
  qualification   String?
  experience      Int            @default(0)
  consultationFee Decimal        @db.Decimal(12, 2) @map("consultation_fee")
  rating          Decimal        @default(0.0) @db.Decimal(3, 2)
  isActive        Boolean        @default(true) @map("is_active")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  appointments    Appointment[]
  doctorSchedules DoctorSchedule[]

  @@map("doctors")
}

model Appointment {
  id              Int               @id @default(autoincrement())
  patientId       Int               @map("patient_id")
  doctorId        Int               @map("doctor_id")
  appointmentDate DateTime          @map("appointment_date")
  appointmentTime String            @map("appointment_time")
  reason          String
  status          AppointmentStatus @default(scheduled)
  diagnosis       String?           @db.Text
  prescription    String?           @db.Text
  notes           String?           @db.Text

  // Used to enforce: unique(doctor_id, appointment_date, appointment_time) when status != "cancelled"
  // active_slot = 1 for scheduled/confirmed/completed/no_show, active_slot = 0 for cancelled
  activeSlot Int @default(1) @map("active_slot")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Restrict)
  doctor  Doctor  @relation(fields: [doctorId], references: [id], onDelete: Restrict)

  @@index([patientId])
  @@index([doctorId])
  @@index([appointmentDate])
  @@unique([doctorId, appointmentDate, appointmentTime, activeSlot], map: "uniq_doctor_date_time_active")
  @@map("appointments")
}

model DoctorSchedule {
  id          Int      @id @default(autoincrement())
  doctorId    Int      @map("doctor_id")
  dayOfWeek   Int      @map("day_of_week")
  startTime   String   @map("start_time")
  endTime     String   @map("end_time")
  isAvailable Boolean  @default(true) @map("is_available")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@index([doctorId, dayOfWeek])
  @@map("doctor_schedules")
}

